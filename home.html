<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© ÙƒÙ† Ø£Ù†Øª | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    
    <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="js/url.js"></script>
    
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ -->
    <link rel="stylesheet" href="assets/fonts/tajawal.css">
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e3c72; 
            --secondary: #2a5298; 
            --accent: #f39c12; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --bg-light: #f4f7f6;
            /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ù…Ù„Ù tajawal.css */
            --main-font: 'Tajawal', Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            font-family: var(--main-font); /* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· Ø§Ù„Ù…ÙˆØ­Ø¯ Ù‡Ù†Ø§ */
        }
        
        body { 
            background: #1e3c72;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh; 
            overflow: hidden;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ©) */
        #weather-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .drop { position: absolute; color: rgba(255,255,255,0.1); will-change: transform; }

        header { 
            position: fixed; top: 0; width: 100%; z-index: 100; padding: 12px 20px;
            background: white; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #main-content {
            position: absolute; top: 70px; bottom: 75px;
            width: 100%; overflow-y: auto; padding: 15px; z-index: 10;
            -webkit-overflow-scrolling: touch;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: white; display: flex; justify-content: space-around; align-items: center;
            z-index: 100; border-top: 1px solid #eee;
        }

        .nav-item { cursor: pointer; text-align: center; color: #7f8c8d; flex: 1; font-size: 0.75rem; }
        .nav-item.active { color: var(--secondary); font-weight: bold; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 2px; }

        /* Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .tab-menu { display: flex; background: rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; padding: 4px; gap: 4px; }
        .tab-link { flex: 1; text-align: center; padding: 8px; color: #eee; cursor: pointer; border-radius: 6px; font-size: 0.8rem; }
        .tab-link.active { background: var(--accent); color: white; font-weight: bold; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… */
        .list-entry { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-radius: 8px; background: #f9f9f9; border-right: 4px solid #ddd; margin-bottom: 8px;
        }
        .list-entry.done { border-right-color: var(--success); background: #f0fff4; }
        .list-entry.pending { border-right-color: var(--accent); }

        .btn-status { border: none; padding: 6px 10px; border-radius: 6px; font-size: 0.7rem; cursor: pointer; font-weight: 500; }
        .btn-done { background: var(--success); color: white; }
        .btn-wait { background: #e0e0e0; color: #555; }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªÙ„Ø§Ø´ÙŠ */
        .fade-in { animation: simpleFade 0.2s ease-out; }
        @keyframes simpleFade { from { opacity: 0; } to { opacity: 1; } }

        @keyframes fall {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="weather-canvas"></div>

<header>
    <div style="display: flex; align-items: center; gap: 8px;">
        <i class="fa-solid fa-circle-user" style="color: var(--secondary); font-size: 1.8rem;"></i>
        <div>
            <h4 id="page-title" style="font-size: 1rem; font-weight: 700;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
            <small id="user-display" style="color: #7f8c8d; font-size: 0.7rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</small>
        </div>
    </div>
    <button onclick="logout()" style="background:none; border:none; color:var(--danger); font-size:1.1rem;"><i class="fa-solid fa-power-off"></i></button>
</header>

<div id="main-content"></div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="showSection('home', this)"><i class="fa-solid fa-house"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
    <div class="nav-item" onclick="showSection('tasks', this)"><i class="fa-solid fa-tasks"></i><span>Ø§Ù„Ù…Ù‡Ø§Ù…</span></div>
    <div class="nav-item" onclick="showSection('reports', this)"><i class="fa-solid fa-chart-bar"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
    <div class="nav-item" onclick="showSection('chat', this)"><i class="fa-solid fa-comment-dots"></i><span>Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</span></div>
</nav>

<script>
    // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    const API_URL = typeof WEB_APP_URL_Main !== 'undefined' ? WEB_APP_URL_Main : "";
    const studentData = JSON.parse(localStorage.getItem('student_session')) || { id: "0", nameAr: "Ø·Ø§Ù„Ø¨" };
    
    window.onload = () => {
        document.getElementById('user-display').innerText = studentData.nameAr;
        initParticles(); // Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ø§Ù„Ø®ÙÙŠÙØ©
        showSection('home');
    };

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function callServer(action, params = {}) {
        try {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            for (let key in params) url.searchParams.append(key, params[key]);
            const response = await fetch(url);
            return await response.json();
        } catch (e) { return null; }
    }

    // --- 2. Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ---
    function showSection(section, el) {
        if(el) {
            const navs = document.querySelectorAll('.nav-item');
            for(let n of navs) n.classList.remove('active');
            el.classList.add('active');
            document.getElementById('page-title').innerText = el.querySelector('span').innerText;
        }

        const container = document.getElementById('main-content');
        
        if (section === 'home') renderHome(container);
        else if (section === 'tasks') renderTasks(container);
        else if (section === 'reports') renderReports(container);
        else if (section === 'chat') window.location.href = 'chat.html';
    }

    // --- 3. Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
    function renderHome(container) {
        container.innerHTML = `
            <div class="fade-in">
                <div class="card" style="background: var(--secondary); color:white;">
                    <h4 style="font-weight:700;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${studentData.nameAr.split(' ')[0]}</h4>
                    <p style="font-size:0.8rem; opacity:0.9;">Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§Ù‹ Ø¯Ø±Ø§Ø³ÙŠØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹</p>
                </div>
                <div class="card" id="stats-box">
                    <p style="text-align:center; color:#999; font-size:0.8rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©...</p>
                </div>
            </div>
        `;
        callServer('getSummary', { studentId: studentData.id }).then(res => {
            if(res && document.getElementById('stats-box')) {
                document.getElementById('stats-box').innerHTML = `
                    <div style="display:flex; justify-content:space-around; font-size:0.9rem;">
                        <div style="text-align:center"><b>${res.attendance || 0}%</b><br><small>Ø­Ø¶ÙˆØ±</small></div>
                        <div style="text-align:center"><b>${res.tasks || 0}</b><br><small>Ù…Ù‡Ø§Ù…</small></div>
                        <div style="text-align:center"><b>${res.points || 0}</b><br><small>Ù†Ù‚Ø§Ø·</small></div>
                    </div>
                `;
            }
        });
    }

    // --- 4. Ù‚Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ù… (ÙŠÙˆÙ…ÙŠØ© + ÙˆØ§Ø¬Ø¨Ø§Øª) ---
    function renderTasks(container) {
        container.innerHTML = `
            <div class="fade-in">
                <div class="tab-menu">
                    <div class="tab-link active" onclick="switchSubTab('sub-daily', this)">Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ©</div>
                    <div class="tab-link" onclick="switchSubTab('sub-hw', this)">ÙˆØ§Ø¬Ø¨Ø§Øª</div>
                </div>
                <div id="sub-daily" class="sub-content">
                    <div class="list-entry pending">
                        <div><b>ØªØ­Ø¶ÙŠØ± Ø¯Ø±Ø³ Ø§Ù„ØºØ¯</b><br><small>Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…</small></div>
                        <button class="btn-status btn-wait" onclick="toggleTask(this, 'task')">Ø¥ØªÙ…Ø§Ù…</button>
                    </div>
                </div>
                <div id="sub-hw" class="sub-content" style="display:none;">
                    <div class="list-entry pending">
                        <div><b>ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</b><br><small>ØªØ³Ù„ÙŠÙ… Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</small></div>
                        <button class="btn-status btn-wait" onclick="toggleTask(this, 'hw')">ØªØ³Ù„ÙŠÙ…</button>
                    </div>
                </div>
            </div>
        `;
    }

    function toggleTask(btn, type) {
        const entry = btn.parentElement;
        if(entry.classList.contains('pending')) {
            entry.classList.replace('pending', 'done');
            btn.classList.replace('btn-wait', 'btn-done');
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            callServer('updateTask', { studentId: studentData.id, type: type });
        }
    }

    // --- 5. Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (4 ØªØ¨ÙˆÙŠØ¨Ø§Øª) ---
    function renderReports(container) {
        container.innerHTML = `
            <div class="fade-in">
                <div class="tab-menu" style="overflow-x:auto; white-space: nowrap;">
                    <div class="tab-link active" onclick="switchSubTab('r1', this)">ÙŠÙˆÙ…ÙŠ</div>
                    <div class="tab-link" onclick="switchSubTab('r2', this)">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
                    <div class="tab-link" onclick="switchSubTab('r3', this)">Ø´Ù‡Ø±ÙŠ</div>
                    <div class="tab-link" onclick="switchSubTab('r4', this)">Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
                </div>
                <div id="r1" class="sub-content card"><h6>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</h6><p>Ø£Ø¯Ø§Ø¡ Ù…Ø³ØªÙ‚Ø± ÙˆØªÙØ§Ø¹Ù„ Ø¬ÙŠØ¯</p></div>
                <div id="r2" class="sub-content card" style="display:none;"><h6>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h6><p>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</p></div>
                <div id="r3" class="sub-content card" style="display:none;"><h6>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h6><p>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø¹Ø§Ù…</p></div>
                <div id="r4" class="sub-content card" style="display:none;"><h6>Ø§Ù„Ø£ÙˆØ³Ù…Ø© ÙˆØ§Ù„Ø¬ÙˆØ§Ø¦Ø²</h6><p>Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</p></div>
            </div>
        `;
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
    function switchSubTab(id, el) {
        const parent = el.parentElement;
        const links = parent.querySelectorAll('.tab-link');
        links.forEach(l => l.classList.remove('active'));
        el.classList.add('active');

        const section = parent.parentElement;
        const contents = section.querySelectorAll('.sub-content');
        contents.forEach(c => c.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    // Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø·Ø§Ø¦Ø±Ø© (Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹)
    function initParticles() {
        const container = document.getElementById('weather-canvas');
        const icons = ['âš›ï¸', 'ğŸ§¬', 'ğŸ’¡'];
        for (let i = 0; i < 6; i++) {
            const drop = document.createElement('div');
            drop.className = 'drop';
            drop.innerHTML = icons[Math.floor(Math.random()*icons.length)];
            drop.style.left = Math.random() * 100 + 'vw';
            drop.style.animation = `fall ${Math.random()*5 + 5}s linear infinite`;
            drop.style.animationDelay = Math.random() * 5 + 's';
            container.appendChild(drop);
        }
    }

    function logout() {
        localStorage.removeItem('student_session');
        window.location.href = "index.html";
    }
</script>

</body>
</html>

