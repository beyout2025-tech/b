<div class="row g-0">
  <div class="col-md-4 border-start bg-light" style="height: 550px;">
    <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
      <h6 class="m-0 fw-bold">صندوق الوارد</h6>
      <button class="btn btn-sm btn-outline-primary" onclick="showNewMailForm()">
        <i class="bi bi-pencil-square"></i> جديد
      </button>
    </div>
    <div id="mail-list" class="list-group list-group-flush overflow-auto style-scroll" style="height: 490px;">
      <div class="text-center p-5 text-muted italic">جاري تحميل البريد...</div>
    </div>
  </div>
  
  <div class="col-md-8" style="height: 550px;">
    <div id="mail-view-container" class="h-100 overflow-auto p-3 bg-white style-scroll">
       <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
          <i class="bi bi-envelope fs-1 mb-2"></i>
          <p>اختر رسالة بريدية لقراءتها أو ابدأ رسالة جديدة</p>
       </div>
    </div>
  </div>
</div>

<script>
// وظائف البريد الداخلي (تعتمد على المتغيرات المعرفة في الملف الأب chat.html)
async function loadMailbox() {
    if(!currentUserId) return;
    const list = document.getElementById('mail-list');
    try {
        const res = await fetch(`${API_URL}?action=fetchMailbox&studentId=${currentUserId}&isAdmin=false`);
        const mails = await res.json();
        
        if (!Array.isArray(mails) || mails.length === 0) {
            list.innerHTML = '<div class="text-center p-4">لا توجد رسائل</div>';
            return;
        }

        list.innerHTML = mails.map(m => {
            const sender = m["المرسل_الاسم"] || m["المرسل"] || "غير معروف";
            const subject = m["الموضوع"] || m["العنوان"] || "بدون عنوان";
            const msgId = m["المعرف_التسلسلي"] || m["id"];
            const date = m["تاريخ_الإرسال"] || "";

            return `
                <div onclick="viewMailDetail('${msgId}')" class="list-group-item list-group-item-action border-0 border-bottom p-3 cursor-pointer">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <span class="fw-bold small text-primary">${sender}</span>
                        <span style="font-size: 9px;" class="text-muted">${date}</span>
                    </div>
                    <div class="fw-bold mb-1 text-dark small text-truncate">${subject}</div>
                </div>`;
        }).join('');
    } catch (e) { list.innerHTML = '<div class="text-center p-4 text-danger">خطأ في التحميل</div>'; }
}

function showNewMailForm() {
    const view = document.getElementById('mail-view-container');
    view.innerHTML = `
        <div class="p-3 border rounded shadow-sm bg-light animate__animated animate__fadeIn">
            <h6 class="fw-bold mb-3">إنشاء رسالة جديدة للإدارة</h6>
            <input type="text" id="mailSubject" class="form-control mb-2" placeholder="الموضوع">
            <textarea id="mailBody" class="form-control mb-3" rows="5" placeholder="اكتب رسالتك هنا..."></textarea>
            <button class="btn btn-primary w-100" id="sendMailBtn" onclick="sendNewMail()">
                إرسال الآن <i class="bi bi-send"></i>
            </button>
        </div>`;
}

async function sendNewMail() {
    const subject = document.getElementById('mailSubject').value;
    const body = document.getElementById('mailBody').value;
    const btn = document.getElementById('sendMailBtn');
    if(!subject || !body) return alert("يرجى ملء كافة الحقول");

    btn.disabled = true;
    btn.innerHTML = "جاري الإرسال...";

    const payload = {
        action: "sendMail",
        senderId: currentUserId,
        senderName: currentUserName,
        subject: subject,
        content: body
    };

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("تم إرسال رسالتك بنجاح");
        loadMailbox();
        document.getElementById('mail-view-container').innerHTML = '<div class="text-center p-5 text-muted">تم الإرسال بنجاح</div>';
    } catch (e) { 
        alert("حدث خطأ أثناء الإرسال");
        btn.disabled = false;
        btn.innerHTML = "إرسال الآن";
    }
}

// بدء التحميل فور استدعاء الملف
loadMailbox();
</script>

